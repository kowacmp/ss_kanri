<%if session[:audit_class] == "0" then %>
	<h1>他売上自主監査報告</h1>
<%else%>
	<h1>他売上本監査報告</h1>
<%end%>

<!-- 検索条件入力領域 BEGIN -->
<%= form_tag({:action => 'hyouji_index' }, { :remote => true }) do %>
<table style="border: 1px solid #7D808A; padding: 5px;">
<tr>
<td>
	
  <table class='rounded-corner' >
  	<tr>
  		<th>対象店舗</th>
  		<td style="background-color: #A5D7AA;">
  			<%=@m_shops.shop_cd%>&nbsp<%=@m_shops.shop_name%>
  		</td>
  	</tr>
  	<tr>
  		<th>監査人</th>
  		<td style="background-color: #A5D7AA;">
  			<%=current_user.account%>&nbsp;<%=current_user.user_name%>
  		</td>
  	</tr>
  </table>
  
</td>
<td>
	
  <table class='rounded-corner' >
  	<tr>
  		<th>監査日(From)</th>
  		<td>
  			<%
  				if params[:kansa].nil? then
  					ymd_from = @from[0]
  					ymd_to   = @to[0]
  					ymd_to_disaled = false
  				else
  					ymd_from = params[:kansa][:from]
  					ymd_from = ymd_from[0..3] + "/" + ymd_from[4..5] + "/" + ymd_from[6..7]
  					ymd_to = params[:kansa][:to]
  					ymd_to = ymd_to[0..3] + "/" + ymd_to[4..5] + "/" + ymd_to[6..7]
  					if @from.length == 1 then
  						ymd_to_disabled = false
  					else
  						ymd_to_disabled = true	
  					end
  				end
  			%>
  			<%=select :kansa, :from, @from, :selected => ymd_from %>
  		</td>
  	</tr>	
  </table>
  
</td>

<td>
  <table class='rounded-corner' >
  	<tr>
  		<th>監査日(To)</th>
  		<td>  			
  			<%=text_field :kansa, :t_to, :size => 10, :maxlength => 10, :value => ymd_to, :disabled => ymd_to_disabled %>
  			<%=hidden_field :kansa, :to, :value => ymd_to %> <!-- textboxが使用不可の場合にPOSTされないためhiddenで送る -->
  			<input type='hidden' id='h_to' value="<%=@to.join(',')%>">
  		</td>
  	</tr>	
  </table>
</td>

</tr>
<tr>
	<td colspan="3" align="right" style="margin-right: 5px;">
		<%= submit_tag '　表　示　', :onclick => "return kansa_from_to_chk()", :disable_with => "処理中です..." %>
	</td>
</tr>
</table>
<% end %>

<script language="JavaScript">
  $(function() {
  	// 監査日Toのカレンダー機能
    $("#kansa_t_to").datepicker();
  
  	// 監査日Fromの変更時にToの自動入力
  	$("#kansa_from")[0].onclick = function() {
  		var from  = $("#kansa_from")[0];
  		var to    = $("#kansa_t_to")[0];
  		var h_to  = $("#h_to")[0];
  		
  		to.value    = h_to.value.split(',')[from.selectedIndex];
  		to.disabled = (from.selectedIndex != 0);
  		to.locked   = (from.selectedIndex == 0);
  		
  	}
  
  });
  
  // 表示ボタン時の入力チェック
  function kansa_from_to_chk() {
  	var from = $("#kansa_from")[0];
  	var to   = $("#kansa_t_to")[0];
  	
  	if (!ckDate(to.value)) {
  		alert('監査日(To)を正しく入力してください。');
  		to.focus();
  		return false;  		
  	}
  	
  	if (from.value > to.value) {
		alert('監査日(From)(To)が前後しています。');
		from.focus();
		return false;
  	}
  	
    // toをセットする
    $("#kansa_to").val(to.value);
    
  	return true;

  }
  
/****************************************************************
* 機　能： 入力された値が日付でYYYY/MM/DD形式になっているか調べる
* 引　数： datestr　入力された値
* 戻り値： 正：true　不正：false
****************************************************************/
function ckDate(datestr) {
    // 正規表現による書式チェック
    if(!datestr.match(/^\d{4}\/\d{2}\/\d{2}$/)){
        return false;
    }
    var vYear = datestr.substr(0, 4) - 0;
    var vMonth = datestr.substr(5, 2) - 1; // Javascriptは、0-11で表現
    var vDay = datestr.substr(8, 2) - 0;
    // 月,日の妥当性チェック
    if(vMonth >= 0 && vMonth <= 11 && vDay >= 1 && vDay <= 31){
        var vDt = new Date(vYear, vMonth, vDay);
        if(isNaN(vDt)){
            return false;
        }else if(vDt.getFullYear() == vYear && vDt.getMonth() == vMonth && vDt.getDate() == vDay){
            return true;
        }else{
            return false;
        }
    }else{
        return false;
    }
}
</script>

<!-- 検索条件入力領域 END -->
<div id='result'>
<% if not(params[:kansa].nil?) then %>
	<%=render :partial => 'hyouji_index'%>
<% end %>
</div>