<%=form_tag({:action => 'update' }, :id => "form_update") do%>

<!-- 検索パラメータ -->
<%=hidden_field :hheader, :kansa,       :value => params[:header][:kansa] %>
<%=hidden_field :hheader, :shop_kbn,    :value => params[:header][:shop_kbn] %>
<%=hidden_field :hheader, :audit_class, :value => params[:header][:audit_class] %>
<%=hidden_field :hheader, :zumi_flg,    :value => params[:header][:zumi_flg] %>

<!-- 書き込み先の情報を付加 -->
<%=hidden_field :approval, :table,         :value => @table %>
<%=hidden_field :approval, :approval_id,   :value => @approval_id %>
<%=hidden_field :approval, :approval_name, :value => @approval_name %>

<table class='rounded-corner' style="width:98%" >

	<!-- DELETE 2012.10.15 ボタンをやめてチェックボックスへ変更
	<tr>
		<td colspan="8" align="right" style="border: none;">
			<input type="button" value=" 　一括 　" onclick="return chk_flgs_all(true);"  <%="disabled = 'disabled'" if (@approval_id == 0) %>><br/>
			<input type="button" value="一括クリア" onclick="return chk_flgs_all(false);" <%="disabled = 'disabled'" if (@approval_id == 0) %>>
		</td>
	</tr>
	-->

	<tr>
		<th>店舗</th>
		<th>監査日</th>
		<th>処理</th>
		<th>種別</th>
		<th>監査人</th>
		<th>立会人</th>
		<th>詳細</th>
		<th>
		<!-- UPDATE 2012.10.15 ボタンをやめてチェックボックスへ変更 -->
			承認<br/>
			<input type="checkbox" id="audit_approves_check_all" />
			<script>
			$(function() {
				$("#audit_approves_check_all").click( function (){ 
					$(":checkbox[id$=approval_flg]:not([disabled=disabled])").prop("checked", $(this).prop("checked"));
				});
			});
			</script>
		<!-- UPDATE 2012.10.15 ボタンをやめてチェックボックスへ変更 -->
		</th>
	</tr>
	
	<% rec_cnt = 0 %>
	<% for approval in @approval do %>
		<% rec_cnt += 1 %>

		<tr>
			<td align="center">
				<% m_shop = MShop.find(approval.m_shop_id) %>
				<%= m_shop.shop_cd %>
				&nbsp;
				<%= m_shop.shop_name %>
			</td>
			<td align="center">
				<%if approval[:audit_date].nil? then%>
				    <%
				      dtf = approval.audit_date_from
				      dts = approval.audit_date_to
				    %>
					<%=dtf[0..3] + "/" + dtf[4..5] + "/" + dtf[6..7] %>
			        ～
			        <%=dts[0..3] + "/" + dts[4..5] + "/" + dts[6..7] %>
			    <%else%>
			        <%
			          dt = approval.audit_date
			        %>
					<%=dt[0..3] + "/" + dt[4..5] + "/" + dt[6..7] %>
			    <%end%>
			</td>
			<td align="center">
				<%=Menu.find(@menu_id).display_name%>
			</td>
			<td align="center">
				<%=MCode.find(:first, :conditions=>["kbn='shop_kbn' and code=?", params[:header][:shop_kbn]]).code_name %>
			</td>
			<td align="center">
				<% user = User.find(approval.created_user_id) %>
				<%= user.user_name %>
			</td>
			<td align="center">
				<% user = User.find(approval.confirm_user_id) %>
				<%= user.user_name %>
			</td>
			<td align="center">
				<%= link_to '参照', :controller => @table, :action => "show", :id => approval.id %>
			</td>
			<td align="center">
				<%
					flg = false
					for i in 1..5 do
						if (approval["approve_id#{i}"].to_s == current_user.id.to_s) then
							flg = true 
						end
					end
				%>
			    <%=hidden_field "approval#{rec_cnt}", :id,               :value   => approval.id %>
				<%=hidden_field "approval#{rec_cnt}", :old_approval_flg, :value   => flg %> 
				<%=check_box    "approval#{rec_cnt}", :approval_flg,     
						{:checked => flg, :disabled => (@approval_id == 0)} , true, false %>
			</td>
		</tr>
		
	<% end %> <!-- for approval in @approval do -->
		
	<tr>
		<td colspan="8" align="right" style="border: none">
			<%= submit_tag '　保　存　', :disable_with => "保存中です...", :confirm => "保存してもよろしいですか？",
				:disabled => (@approval_id == 0) %>
		</td>
	</tr>
		
</table>
<% end %> <!-- form_tag({:action => 'update' }, :id => "form_update") do -->

<script>
	
	// 承認の全てを一括ON/OFFする
	function chk_flgs_all(flg) {
		$(":checkbox[id$=approval_flg]").each(function() {
			this.checked = flg;
		});
		
		return true;
	}
	
</script>